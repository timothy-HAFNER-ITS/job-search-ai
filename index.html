<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Search AI - Upload CV</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .job-card {
            transition: all 0.2s ease-in-out;
        }
        .job-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15);
            border-color: #6366f1; /* Indigo-500 */
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Select Styles */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i data-lucide="bot" class="text-indigo-600 w-8 h-8"></i>
                    <span class="font-bold text-xl tracking-tight">JobSearch<span class="text-indigo-600">AI</span></span>
                </div>
                <div>
                    <!-- Debug Link to clear Ngrok warning -->
                    <a href="https://7ea9cbe798d9.ngrok-free.app/webhook-test/cv" target="_blank" class="text-xs font-medium text-slate-400 hover:text-indigo-600 transition-colors flex items-center gap-1">
                        <i data-lucide="shield-check" class="w-3 h-3"></i> Verify Connection
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow">
        <!-- Hero Section -->
        <div class="relative overflow-hidden pt-12 pb-12 sm:pt-20 sm:pb-16">
            <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 sm:text-5xl md:text-6xl mb-6">
                    <span class="block">Upload CV & Find Jobs.</span>
                    <span class="block text-indigo-600 text-3xl sm:text-5xl mt-2">Tailored to your skills.</span>
                </h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-500 mb-10">
                    Select a platform, define your role, and let our AI match your resume to the best opportunities instantly.
                </p>

                <!-- Upload Form -->
                <div class="max-w-xl mx-auto glass-panel rounded-2xl shadow-xl p-8 transform transition-all text-left">
                    <form id="uploadForm" class="space-y-6">

                        <!-- 1. Job Site & Keyword Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Provider Select -->
                            <div>
                                <label for="provider" class="block text-sm font-medium text-slate-700 mb-1">Job Website</label>
                                <div class="relative">
                                    <select id="provider" class="block w-full pl-3 pr-10 py-3 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-xl border bg-slate-50 hover:bg-white transition-colors">
                                        <option value="randstad">Randstad.de</option>
                                        <option value="indeed">Indeed.de</option>
                                        <option value="stepstone">StepStone.de</option>
                                        <option value="linkedin">LinkedIn Jobs</option>
                                        <option value="monster">Monster.de</option>
                                        <option value="xing">Xing Jobs</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Keyword Input -->
                            <div>
                                <label for="keyword" class="block text-sm font-medium text-slate-700 mb-1">Job Title / Keyword</label>
                                <div class="relative">
                                    <input type="text" id="keyword" placeholder="e.g. Project Manager" required
                                        class="block w-full pl-3 pr-3 py-3 border-slate-300 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-xl border bg-slate-50 hover:bg-white transition-colors placeholder-slate-400">
                                </div>
                            </div>
                        </div>

                        <!-- 2. Dropzone -->
                        <div class="w-full">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Your CV</label>
                            <label for="cv-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-indigo-100 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-indigo-50/50 transition-colors group">
                                <div class="flex flex-col items-center justify-center pt-4 pb-4">
                                    <div class="flex items-center gap-2 mb-1">
                                        <i data-lucide="upload-cloud" class="w-5 h-5 text-indigo-600"></i>
                                        <p class="text-sm text-slate-600"><span class="font-semibold text-indigo-600">Click to upload</span></p>
                                    </div>
                                    <p class="text-xs text-slate-400">PDF, DOCX (Max 5MB)</p>
                                    <p id="fileName" class="text-sm font-medium text-indigo-600 mt-2 hidden"></p>
                                </div>
                                <input id="cv-upload" type="file" class="hidden" accept=".pdf,.doc,.docx" required />
                            </label>
                        </div>

                        <!-- 3. Submit Button -->
                        <button type="submit" id="submitBtn" class="w-full flex items-center justify-center py-4 px-6 border border-transparent rounded-xl shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all disabled:opacity-70 disabled:cursor-not-allowed">
                            <span id="btnText">Analyze & Find Jobs</span>
                            <div id="btnLoader" class="loader hidden ml-2"></div>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden bg-slate-50 py-16 border-t border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">Matched Jobs</h2>
                        <p class="mt-2 text-slate-500">Based on your skills and <span id="searchContext" class="font-medium text-indigo-600"></span></p>
                    </div>
                    <span id="jobCount" class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">0 found</span>
                </div>

                <!-- Job Grid -->
                <div id="jobGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Cards will be injected here via JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-auto">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">&copy; 2025 Job Search AI. Powered by n8n & Python.</p>
        </div>
    </footer>

    <script>
        // --- CONFIGURATION ---
        // UPDATED Webhook URL
        const N8N_WEBHOOK_URL = 'https://2363c92a4c6b.ngrok-free.app/webhook-test/cv';

        // --- DOM ELEMENTS ---
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('cv-upload');
        const fileNameDisplay = document.getElementById('fileName');
        const providerSelect = document.getElementById('provider');
        const keywordInput = document.getElementById('keyword');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoader = document.getElementById('btnLoader');
        const resultsSection = document.getElementById('resultsSection');
        const jobGrid = document.getElementById('jobGrid');
        const jobCountBadge = document.getElementById('jobCount');
        const searchContext = document.getElementById('searchContext');

        // Initialize Icons
        lucide.createIcons();

        // --- URL BUILDER LOGIC ---
        function buildSearchUrl(provider, keyword) {
            const k = keyword.trim();
            const kSlug = k.toLowerCase().replace(/\s+/g, '-'); // "project manager" -> "project-manager"
            const kEncoded = encodeURIComponent(k); // "project manager" -> "project%20manager"

            switch (provider) {
                case 'randstad':
                    return `https://www.randstad.de/jobs/q-${kSlug}/`;
                case 'indeed':
                    return `https://de.indeed.com/jobs?q=${kEncoded}`;
                case 'stepstone':
                    return `https://www.stepstone.de/jobs/${kSlug}`;
                case 'linkedin':
                    return `https://www.linkedin.com/jobs/search/?keywords=${kEncoded}`;
                case 'monster':
                    return `https://www.monster.de/jobs/suche?q={encoded}`;
                case 'xing':
                    return `https://www.xing.com/jobs/search?keywords=${kEncoded}`;
                default:
                    return '';
            }
        }

        // --- EVENT LISTENERS ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = `Selected: ${file.name}`;
                fileNameDisplay.classList.remove('hidden');
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const file = fileInput.files[0];
            const provider = providerSelect.value;
            const keyword = keywordInput.value;

            if (!file) {
                alert('Please select a CV file first.');
                return;
            }
            if (!keyword) {
                alert('Please enter a job title or keyword.');
                return;
            }

            const targetUrl = buildSearchUrl(provider, keyword);
            console.log("Target URL:", targetUrl);

            setLoading(true);
            resultsSection.classList.add('hidden');
            jobGrid.innerHTML = '';
            searchContext.textContent = `"${keyword}" on ${providerSelect.options[providerSelect.selectedIndex].text}`;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('url', targetUrl);

                console.log("Sending request to n8n...");

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server Error:', response.status, response.statusText, errorText);
                    throw new Error(`Failed to analyze CV. Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("Raw Response Data:", data);

                let jobs = [];
                // Check all possible JSON structures
                if (Array.isArray(data) && data.length > 0) {
                    if (data[0].output && Array.isArray(data[0].output)) {
                        jobs = data[0].output;
                    } else if (data[0].jobs && Array.isArray(data[0].jobs)) {
                        jobs = data[0].jobs;
                    } else if (Array.isArray(data[0])) {
                        jobs = data[0];
                    } else if (data[0].json && data[0].json.output) {
                        jobs = data[0].json.output;
                    }
                } else if (data.output) {
                    jobs = data.output;
                }

                renderJobs(jobs);

            } catch (error) {
                console.error('Full Error Object:', error);
                alert(`Error: ${error.message}. Please check if n8n is active (Execute Workflow).`);
            } finally {
                setLoading(false);
            }
        });

        // --- HELPERS ---

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                btnText.textContent = 'Searching & Analyzing... (Takes ~2 mins)';
                btnLoader.classList.remove('hidden');
            } else {
                btnText.textContent = 'Analyze & Find Jobs';
                btnLoader.classList.add('hidden');
            }
        }

        function renderJobs(jobs) {
            if (!jobs || jobs.length === 0) {
                alert("No matching jobs found.");
                return;
            }

            jobCountBadge.textContent = `${jobs.length} found`;

            jobs.forEach(job => {
                const card = document.createElement('div');
                card.className = 'glass-panel rounded-xl job-card border border-slate-200 flex flex-col h-full bg-white overflow-hidden';

                // MAPPING DATA
                const title = job.job_title || job.title || 'Untitled Position';
                const company = job.company || 'Confidential';
                const location = job.location || 'Remote / Unspecified';
                const salary = job.salary || 'Salary not specified';
                const link = job.link || '#';
                const description = job.description || 'No description available.';
                const type = job.employment_type || 'Full-time';
                const date = job.pubDate ? new Date(job.pubDate).toLocaleDateString() : 'Recently';
                const matchScore = job.match_score || 0;

                // Processing Requirements (split by semicolon)
                let requirementsHtml = '';
                if (job.requirements) {
                    const reqs = job.requirements.split(';').map(r => r.trim()).filter(r => r.length > 0);
                    // Show max 4 tags
                    reqs.slice(0, 4).forEach(req => {
                        requirementsHtml += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700 mr-2 mb-2 border border-slate-200">${req}</span>`;
                    });
                    if (reqs.length > 4) {
                        requirementsHtml += `<span class="inline-flex items-center px-2 py-0.5 text-xs font-medium text-slate-400 mb-2">+${reqs.length - 4} more</span>`;
                    }
                }

                // Match Score Color Logic
                let scoreColorClass = 'bg-blue-100 text-blue-800';
                if (matchScore >= 90) scoreColorClass = 'bg-green-100 text-green-800';
                else if (matchScore < 70) scoreColorClass = 'bg-yellow-100 text-yellow-800';

                card.innerHTML = `
                    <div class="p-6 flex flex-col h-full">
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 pr-4">
                                <h3 class="text-lg font-bold text-slate-900 leading-tight mb-1">${title}</h3>
                                <div class="flex items-center text-sm text-indigo-600 font-medium">
                                    <i data-lucide="building-2" class="w-4 h-4 mr-1.5"></i>
                                    ${company}
                                </div>
                            </div>
                            <div class="${scoreColorClass} px-2.5 py-1 rounded-lg text-xs font-bold whitespace-nowrap flex items-center">
                                ${matchScore}% Match
                            </div>
                        </div>

                        <!-- Meta Grid -->
                        <div class="grid grid-cols-2 gap-y-2 gap-x-4 mb-4 text-sm text-slate-500">
                            <div class="flex items-center">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-2 text-slate-400"></i>
                                ${location}
                            </div>
                            <div class="flex items-center">
                                <i data-lucide="clock" class="w-4 h-4 mr-2 text-slate-400"></i>
                                ${type}
                            </div>
                            <div class="flex items-center col-span-2">
                                <i data-lucide="banknote" class="w-4 h-4 mr-2 text-slate-400"></i>
                                ${salary}
                            </div>
                        </div>

                        <!-- Requirements Tags -->
                        <div class="mb-4">
                            ${requirementsHtml}
                        </div>

                        <!-- Description -->
                        <div class="flex-grow">
                            <p class="text-slate-600 text-sm mb-4 line-clamp-4 leading-relaxed">
                                ${description}
                            </p>
                        </div>

                        <!-- Footer -->
                        <div class="mt-auto pt-4 border-t border-slate-100 flex items-center justify-between">
                            <span class="text-xs text-slate-400">Posted: ${date}</span>
                            <a href="${link}" target="_blank" class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-sm hover:shadow">
                                Apply Now
                                <i data-lucide="external-link" class="w-4 h-4 ml-2"></i>
                            </a>
                        </div>
                    </div>
                `;

                jobGrid.appendChild(card);
            });

            lucide.createIcons();

            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
